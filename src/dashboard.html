<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <title>xpede</title>
</head>

<body style="margin: 1em; overflow: scroll;">
    <div class="dashboard">

    </div>

    <div class="prototypes">

        <div class="expedition card text-white bg-secondary mb-3">
            <div class="card-header">
                <img src="../assets/icons/expedition.png" style="height: 4em; margin-right: 1em;"
                    class="icon float-start">
                <h1 class="name">Expedition Name</h1>
            </div>

            <div class="card-body collapse show">
                <div class="clearfix">
                    <img src="../assets/icons/stakeholders.png" style="height: 2em; margin-right: 0.5em;"
                        title="Stakeholders" class="icon float-start">
                    <div class="stakeholders">Some stakeholders</div>
                </div>
                <div class="clearfix">
                    <img src="../assets/icons/participants.png" style="height: 2em; margin-right: 0.5em;"
                        title="Participants" class="icon float-start">
                    <div class="participants">Some participants</div>
                </div>
                <div class="history">
                    <canvas width="100" height="150"></canvas>
                </div>

                <div class="goals"></div>
            </div>
        </div>

        <div class="indicator card text-white bg-secondary mt-3">
            <div class="card-header">
                <img src="../assets/icons/summit.png" style="height: 2.5em; margin-right: .5em;"
                    class="icon float-start">
                <h2 class="name">Summit Name</h2>
            </div>

            <div class="card-body collapse show">
                <p class="description">Some description</p>
                <div class="extra"></div>
                <div class="history">
                    <canvas width="100" height="150"></canvas>
                </div>
                <div class="children"></div>
            </div>
        </div>

        <div class="target">
            <h5>Good: <span class="good"></span></h5>
            <h5>OK: <span class="ok"></span></h5>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <script>
        const expedition = /**EXPEDITION*/testExpedition()/*EXPEDITION**/

        const $dashboard = $('.dashboard')
        const $proto = $('.prototypes').remove()

        document.title = "Status of " + expedition.name

        const then = []
        $dashboard.append(renderExpedition(expedition))
        then.forEach(t => t())
        $('.collapse.show').removeClass('show')

        function proto(of) {
            return $proto.find('.' + of).clone()
        }

        function renderExpedition(expedition) {
            $expedition = proto('expedition')

            $expedition.find('.name').html(expedition.name)

            $expedition.find('.stakeholders').html(printParty(expedition.stakeholders))
            $expedition.find('.participants').html(printParty(expedition.participants))

            const $body = $expedition.find('.card-body')[0]
            $expedition.find('.card-header').on('click', () =>
                new bootstrap.Collapse($body))

            colorCode($expedition, expedition.history)
            then.push(() => drawGraph($expedition.find('.history'), expedition.history))

            $expedition.find('.goals').append(renderAny(expedition.summit, 'summit'))
            expedition.waypoints.forEach(waypoint =>
                $expedition.find('.goals').append(renderAny(waypoint, 'waypoint')))

            return $expedition
        }

        function printParty(party) {
            return (party.name
                + (party.members
                    ? ' (' + party.members.map(m => printParty(m)).join(', ') + ')'
                    : '')).trim()
        }

        function renderAny(indicator, role) {
            switch (indicator.type) {
                case 'goal': return renderGoal(indicator, role)
                case 'target': return renderTarget(indicator, role)
                default: throw new Error('Unknown type: ' + indicator)
            }
        }

        function renderIndicator(indicator, role) {
            $indicator = proto('indicator')

            $indicator.find('img').prop('src', '../assets/icons/' + role + '.png')
            $indicator.find('.name').html(indicator.name)
            $indicator.find('.description').html(indicator.description)

            const $body = $indicator.find('.card-body')[0]
            $indicator.find('.card-header').on('click', () =>
                new bootstrap.Collapse($body))

            colorCode($indicator, indicator.history)
            const $history = $indicator.find('.history')
            then.push(() => drawGraph($history, indicator.history))

            return $indicator
        }

        function renderGoal(goal, role) {
            const $goal = renderIndicator(goal, role)

            const $children = $goal.find('.children').first()
            goal.progress.forEach(indicator =>
                $children.append(renderAny(indicator, 'progress')))
            goal.location.forEach(indicator =>
                $children.append(renderAny(indicator, 'location')))

            return $goal
        }

        function renderTarget(target, role) {
            const $target = renderIndicator(target, role)

            const $extra = proto('target')
            $target.find('.extra').first().append($extra)

            $extra.find('.ok').html(target.ok)
            $extra.find('.good').html(target.good)

            return $target
        }

        // function renderIndicator($container, indicator, isCriterion) {
        //     $indicator = $_indicator.clone()
        //     $container.append($indicator)

        //     if (isCriterion) $indicator.find('img').prop('src', '../assets/icons/criterion.png')

        //     $indicator.find('.caption').html(indicator.caption)
        //     $indicator.find('.description').html(indicator.description)

        //     if (!indicator.metric) {
        //         $indicator.find('.card-body').remove()
        //         return -Infinity
        //     }

        //     return renderMetric($indicator, indicator.ok, indicator.good, indicator.metric)
        // }

        // function renderMetric($indicator, ok, good, metric) {
        //     $indicator.find('.metric').html(metric.caption)
        //     $indicator.find('.metric').prop('title', metric.description)

        //     const status = metric.data[metric.data.length - 1]
        //     if (!status) {
        //         $indicator.find('.value').html('')
        //         $indicator.find('.graph').html('ok: ' + ok + '<br>good: ' + good)
        //         return -Infinity
        //     }

        //     let score = -Infinity
        //     if (ok !== null && good !== null) score = (status.value - ok) / (good - ok)

        //     colorCode($indicator, score)
        //     $indicator.find('.value').html(Math.round(status.value * 100) / 100)

        //     const $graph = $indicator.find('.graph')
        //     then.push(() => drawGraph($graph, ok, good, metric.data))

        //     return score

        // }

        function drawGraph($container, data) {
            const fontSize = 20
            const padding = fontSize * 1.5
            const margin = 5
            const window = expedition.weeks * 7 * 24 * 3600 * 1000

            const $canvas = $container.find('canvas')
            const ctx = $canvas[0].getContext("2d");

            const width = $container.width() - margin
            const height = $canvas.prop('height')
            $canvas.prop('width', width + margin)

            ctx.strokeStyle = "white";
            ctx.fillStyle = "white"
            ctx.font = fontSize + "px Arial"
            ctx.textAlign = "right"

            const now = new Date()
            const start = new Date(now.getTime() - window)

            const inWindow = data.filter(s => new Date(s.at) >= start).map(s => s.score)
            const max = inWindow.reduce((acc, s) => Math.max(acc, s), 1)
            const min = inWindow.reduce((acc, s) => Math.min(acc, s), 0)

            const dx = width / (now - start)
            const dy = (height - padding * 2) / (max - min)

            const x = date => (date - start) * dx
            const y = score => height - padding - (score - min) * dy

            ctx.lineWidth = 9
            ctx.beginPath()
            data.forEach((status, i) =>
                (i ? ctx.lineTo : ctx.moveTo)
                    .call(ctx, x(new Date(status.at)), y(status.score)))
            ctx.stroke()

            data.forEach(status => {
                ctx.beginPath();
                ctx.arc(x(new Date(status.at)), y(status.score), 6, 0, 2 * Math.PI, false);
                ctx.fill();
            })

            ctx.lineWidth = 3;
            const stroke = (x1, y1, x2, y2) => {
                ctx.beginPath()
                ctx.moveTo(x(x1), y(y1))
                ctx.lineTo(x(x2), y(y2))
                ctx.stroke()
            }
            stroke(start, 0, now, 0)
            stroke(start, 1, now, 1)

            for (let w = start.getTime(); w <= now.getTime(); w += 7 * 24 * 3600 * 1000) {
                stroke(new Date(w), 5 / dy, new Date(w), -5 / dy)
            }

            // const write = (value, x1, y1, offset = fontSize) => ctx.fillText(value, x(x1) - 2, y(y1) + offset)


            // const format = n => Math.round(n * 10) / 10
            // if (good !== null) {
            //     stroke(start, 1, now, 1)
            //     write('good ' + format(good), now, 1, 10 - fontSize)
            // } else {
            //     stroke(start, max, now, max)
            //     write('max ' + format(max), now, max, 10 - fontSize)
            // }

            // if (ok !== null) {
            //     stroke(start, 0, now, 0)
            //     write('ok ' + format(ok), now, 0)

            // } else {
            //     stroke(start, min, now, min)
            //     write('min ' + format(min), now, min)
            // }
        }

        function colorCode($element, history) {
            if (history.length == 0) return

            const score = history[history.length - 1].score
            if (score >= 1) return $element.addClass('bg-success')
            if (score < 0) return $element.addClass('bg-danger')
            else return $element.addClass('bg-warning')
        }

        function testExpedition() {
            const weeks = 8

            return {
                weeks,
                name: 'Foo',
                participants: {
                    name: 'Team Bar',
                    members: [
                        { name: 'John' },
                        { name: 'Peter' },
                        { name: 'Jane' }]
                },
                stakeholders: {
                    name: 'James'
                },
                summit: testSummit('One'),
                waypoints: [
                    testGoal('Two'),
                    testGoal('Three'),
                    testGoal('Four'),
                    testGoal('Five'),
                    testGoal('Six')
                ].slice(0, Math.random() * 4 + 2),
                history: testHistory()
            }

            function testSummit(name) {
                return {
                    type: 'goal',
                    name,
                    description: 'I am number ' + name.toLowerCase(),
                    location: [
                        testGoal('Goal one'),
                        testGoal('Goal two'),
                        testGoal('Goal three')
                    ].slice(0, Math.random() * 2 + 2),
                    progress: [],
                    history: testHistory()
                }
            }

            function testGoal(name) {
                return {
                    type: 'goal',
                    name,
                    description: 'I am number ' + name.toLowerCase(),
                    location: [
                        name == 'One'
                            ? testGoal('Goal one of ' + name)
                            : testTarget('Location one of ' + name),
                        testTarget('Location two of ' + name),
                        testTarget('Location three of ' + name)
                    ].slice(0, Math.random() * 2 + 2),
                    progress: [
                        testTarget('Progress one of ' + name),
                        testTarget('Progress two of ' + name),
                        testTarget('Progress three of ' + name),
                    ].slice(0, Math.random() < .4 ? 0 : Math.random() * 2 + 2),
                    history: testHistory()
                }
            }

            function testTarget(name) {
                return {
                    type: 'target',
                    name,
                    description: 'I have reached ' + name,
                    ok: Math.round(Math.random() * 12),
                    good: Math.round(Math.random() * 21 + 12),
                    history: testHistory(),
                    metric: testMetric()
                }
            }

            function testHistory(ok, good) {
                const history = []
                for (let daysAgo = Math.random() * 7; daysAgo < Math.random() * weeks * 14 + 14; daysAgo += Math.random() * 4 + 3) {
                    history.unshift({
                        at: new Date(new Date().getTime() - daysAgo * 24 * 3600 * 1000),
                        score: Math.random() * 4 - 1
                    })
                }
                return history
            }

            function testMetric() {
                // TODO
            }
        }
    </script>

</body style="overflow: scroll;">

</html>
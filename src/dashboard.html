<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <title>xpede</title>
</head>

<body style="overflow: scroll;">
    <div>
        <div class="dashboard row m-3">
            <div class="mountain col" style="min-width: 26em; max-width: 52.5em;">

                <div class="mountain-info card text-white bg-secondary mb-3">
                    <div class="card-header">
                        <img src="../assets/icons/mountain.png" style="height: 6em" class="icon float-start mr-3">
                        <h1 class="name">Mountain Name</h1>
                        <p class="reason card-title">Reason to climb</p>
                    </div>

                    <div class="card-body collapse show">
                        <div class="indicators collapse show">
                            <div class="indicator card text-white bg-secondary mb-3">
                                <div class="card-header">
                                    <img src="../assets/icons/indicator.png" style="height: 4em"
                                        class="icon float-start mr-3">
                                    <h3 class="caption">Indicator caption</h3>
                                    <p class="description">Indicator description</p>
                                </div>
                                <div class="card-body">
                                    <h5 class="value card-title float-end">current value</h5>
                                    <h5 class="metric card-title" title="Metric description">Metric caption</h5>
                                    <div class="graph">
                                        <canvas width="100" height="150"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="goals collapse show">
                    <div class="goal">
                        <div class="goal-info card text-white bg-secondary mb-3">
                            <div class="card-header">
                                <img src="../assets/icons/summit.png" style="height: 4em" class="icon float-start mr-3">
                                <h2 class="caption">Goal caption</h2>
                                <p class="description">Goal description</p>
                            </div>

                            <div class="criteria card-body collapse show"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <script>
        const model = /**STATUS*/testStatus()/*STATUS**/

        const $dashboard = $('.dashboard')
        const $_goal = $('.goal').remove()
        const $_indicator = $('.indicator').remove()
        const $_mountain = $('.mountain').remove()

        document.title = model.name

        const then = []
        model.mountains.forEach(renderMountain)
        then.forEach(t => t())
        $('.collapse.show').removeClass('show')

        function renderMountain(mountain) {
            $mountain = $_mountain.clone()
            $dashboard.append($mountain)
            $mountain.find('.mountain-info .name').html(mountain.name)
            $mountain.find('.mountain-info .reason').html(mountain.reason)

            const $body = $mountain.find('.card-body')
            const $goals = $mountain.find('.goals')
            $mountain.find('.mountain-info .card-header').on('click', () => {
                new bootstrap.Collapse($goals[0])
                new bootstrap.Collapse($body[0])
            })

            const $indicators = $mountain.find('.indicators')
            $body.on('click', () => new bootstrap.Collapse($indicators[0]))

            if (mountain.indicators.length === 0) $mountain.find('.card-body').remove()

            const score = mountain.indicators
                .map(indicator => renderIndicator($mountain.find('.indicators'), indicator))
                .reduce((min, score) => Math.min(min, score), Infinity)

            const goals = mountain.goals.reverse()
                .map((goal, i) => renderGoal($mountain, goal, i > 0))
                .reduce((min, score) => Math.min(min, score), Infinity)

            colorCode($mountain.find('.mountain-info'), score < Infinity ? score : goals)
        }

        function renderGoal($mountain, goal, isStopover) {
            $goal = $_goal.clone()
            $mountain.find('.goals').append($goal)

            if (isStopover) $goal.find('img').prop('src', '../assets/icons/stopover.png')

            $goal.find('.goal-info .caption').html(goal.caption)
            $goal.find('.goal-info .description').html(goal.description)

            const $criteria = $goal.find('.criteria')
            $goal.on('click', () => {
                new bootstrap.Collapse($criteria[0])
            })

            if (goal.criteria.length === 0) $goal.find('.criteria').remove()

            const score = goal.criteria
                .map(indicator => renderIndicator($goal.find('.criteria'), indicator, true))
                .reduce((min, score) => Math.min(min, score), Infinity)

            colorCode($goal.find('.goal-info'), score)

            return score
        }

        function renderIndicator($container, indicator, isCriterion) {
            $indicator = $_indicator.clone()
            $container.append($indicator)

            if (isCriterion) $indicator.find('img').prop('src', '../assets/icons/criterion.png')

            $indicator.find('.caption').html(indicator.caption)
            $indicator.find('.description').html(indicator.description)

            if (!indicator.metric) {
                $indicator.find('.card-body').remove()
                return -Infinity
            }

            return renderMetric($indicator, indicator.ok, indicator.good, indicator.metric)
        }

        function renderMetric($indicator, ok, good, metric) {
            $indicator.find('.metric').html(metric.caption)
            $indicator.find('.metric').prop('title', metric.description)

            const status = metric.data[metric.data.length - 1]
            if (!status) {
                $indicator.find('.value').html('')
                $indicator.find('.graph').html('ok: ' + ok + '<br>good: ' + good)
                return -Infinity
            }

            let score = -Infinity
            if (ok !== null && good !== null) score = (status.value - ok) / (good - ok)

            colorCode($indicator, score)
            $indicator.find('.value').html(Math.round(status.value * 100) / 100)

            const $graph = $indicator.find('.graph')
            then.push(() => drawGraph($graph, ok, good, metric.data))

            return score

        }

        function drawGraph($graph, ok, good, data) {
            const fontSize = 20
            const padding = fontSize * 1.5
            const margin = 5
            const window = 8 * 7 * 24 * 3600 * 1000

            const $canvas = $graph.find('canvas')
            const ctx = $canvas[0].getContext("2d");

            const width = $graph.width() - margin
            const height = $canvas.prop('height')
            $canvas.prop('width', width + margin)

            ctx.strokeStyle = "white";
            ctx.fillStyle = "white"
            ctx.font = fontSize + "px Arial"
            ctx.textAlign = "right"

            const now = new Date()
            const start = new Date(now.getTime() - window)
            const inWindow = data.filter(s => new Date(s.at) >= start)

            const norm = (ok !== null && good !== null)
                ? value => (value - ok) / (good - ok)
                : value => value

            const max = inWindow.reduce((acc, i) => Math.max(acc, norm(i.value)), 1)
            const min = inWindow.reduce((acc, i) => Math.min(acc, norm(i.value)), 0)

            const dx = width / (now - start)
            const dy = (height - padding * 2) / (max - min)

            const x = date => (date - start) * dx
            const y = normalized => height - padding - (normalized - min) * dy

            ctx.lineWidth = 9
            ctx.beginPath()
            data.forEach((status, i) =>
                (i ? ctx.lineTo : ctx.moveTo)
                    .call(ctx, x(new Date(status.at)), y(norm(status.value))))
            ctx.stroke()

            data.forEach(status => {
                ctx.beginPath();
                ctx.arc(x(new Date(status.at)), y(norm(status.value)), 6, 0, 2 * Math.PI, false);
                ctx.fill();
            })

            const format = i => Math.round(i * 10) / 10
            const write = (value, x1, y1, offset = fontSize) => ctx.fillText(value, x(x1) - 2, y(y1) + offset)
            const stroke = (x1, y1, x2, y2) => {
                ctx.beginPath()
                ctx.moveTo(x(x1), y(y1))
                ctx.lineTo(x(x2), y(y2))
                ctx.stroke()
            }

            ctx.lineWidth = 3;

            if (good !== null) {
                stroke(start, 1, now, 1)
                write('good ' + format(good), now, 1, 10 - fontSize)
            } else {
                stroke(start, max, now, max)
                write('max ' + format(max), now, max, 10 - fontSize)
            }

            if (ok !== null) {
                stroke(start, 0, now, 0)
                write('ok ' + format(ok), now, 0)

                for (let w = start.getTime(); w <= now.getTime(); w += 7 * 24 * 3600 * 1000) {
                    stroke(new Date(w), 5 / dy, new Date(w), -5 / dy)
                }
            } else {
                stroke(start, min, now, min)
                write('min ' + format(min), now, min)
            }
        }

        function colorCode($element, score) {
            if (score === Infinity || score === -Infinity) return
            if (score >= 1) return $element.addClass('bg-success')
            if (score < 0) return $element.addClass('bg-danger')
            else return $element.addClass('bg-warning')
        }

        function testStatus() {

            function testMountain(name) {
                return {
                    "name": name,
                    "reason": "Because " + name.toLowerCase(),
                    "goals": [
                        ...[
                            testGoal("Stopover one of " + name),
                            testGoal("Stopover two of " + name),
                            testGoal("Stopover three of " + name)
                        ].slice(0, Math.random() * 3.5),
                        testGoal("Top of " + name),
                    ],
                    "indicators": Math.random() < .5 ? [] : [
                        testIndicator(name, 'one'),
                        testIndicator(name, 'two'),
                        testIndicator(name, 'three'),
                        testIndicator(name, 'four'),
                        testIndicator(name, 'five'),
                    ].slice(0, Math.random() * 3.5 + 2)
                }
            }

            function testGoal(name) {
                return {
                    "caption": name,
                    "description": "I have reached " + name,
                    "criteria": [
                        testIndicator(name, 'one'),
                        testIndicator(name, 'two'),
                        testIndicator(name, 'three'),
                    ]
                }
            }

            function testIndicator(parent, name) {
                const ok = Math.random() > .1 ? Math.random() * 10 : null
                const good = Math.random() > .1 ? Math.random() * 20 + 15 : null

                return {
                    "caption": "Be " + name + " with " + parent,
                    "description": "Be a " + name + " not a foo",
                    "ok": ok,
                    "good": good,
                    "metric": {
                        "caption": name + " of " + parent + " Metric",
                        "description": "Some Metric for " + name + " of " + parent,
                        "data": testData(ok, good)
                    }
                }
            }

            function testData(ok, good) {
                const data = []
                for (let i = Math.random() * 7; i < Math.random() * 60 + 20; i += Math.random() * 4 + 3) {
                    const value = Math.random() * 40 - 10
                    data.unshift({
                        "at": new Date(new Date().getTime() - i * 24 * 3600 * 1000),
                        "value": value,
                        "score": (ok !== null && good !== null) ? (value - ok) / (good - ok) : null
                    })
                }
                return data
            }

            return {
                "name": "Foo",
                "mountains": [
                    testMountain('One'),
                    testMountain('Two'),
                    testMountain('Three'),
                    testMountain('Four'),
                    testMountain('Five'),
                    testMountain('Six'),
                ].slice(0, Math.random() * 4.5 + 2)
            }
        }
    </script>

</body style="overflow: scroll;">

</html>
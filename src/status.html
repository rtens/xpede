<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="assets/bootstrap.min.css">

    <title>xpede | Status</title>
</head>

<body>
    <div>
        <div id="dashboard" class="row m-3">
            <div id="mountain" class="col-12 col-md-4">

                <div class="about card text-white bg-secondary mb-3">
                    <div class="card-header">
                        <img src="assets/icons/mountain.png" style="height: 6em" class="icon float-left mr-3">
                        <h1 class="name">Mountain Name</h1>
                        <p class="summit card-title">Summit description</p>
                    </div>
                </div>

                <div id="indicator" class="card text-white mb-3">
                    <div class="card-header">
                        <img src="assets/icons/indicator.png" style="height: 4em" class="icon float-left mr-3">
                        <h3 class="summary">Indicator Summary</h3>
                        <p class="description">Indicator description</p>
                    </div>
                    <div class="card-body">
                        <h5 class="value card-title float-right">current value</h5>
                        <h5 class="dimension card-title">Dimension Summary</h5>
                        <div class="graph">
                            <canvas width="100" height="150"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="assets/jquery-3.5.1.slim.min.js"></script>

    <script>
        const daysAgo = d => new Date(new Date().getTime() - d * 24 * 3600 * 1000).toISOString()
        const model = /**MODEL*/[{ "name": "Foo", "summit": "I am at bar", "indicators": [{ "summary": "One Location", "target": { "type": "LocationTarget", "dimension": "Some dimension", "good": 42.1234, "ok": 21.4567, "history": [{ "date": daysAgo(35), "score": .1 }, { "date": daysAgo(27), "score": 0.5 }, { "date": daysAgo(20), "score": 1.2 }, { "date": daysAgo(14), "score": 0.9 }, { "date": daysAgo(5), "score": 1.2, "value": 44.3456 }] } }, { "summary": "One Arrival", "target": { "type": "ArrivalTarget", "dimension": "Bar", "value": 42, "good": "2021-04-01T00:00:00.000Z", "ok": "2021-08-01T00:00:00.000Z", "history": [{}, { "date": daysAgo(42), "value": null, "score": null }, { "date": daysAgo(32), "score": 1.3 }, { "date": daysAgo(27), "score": 0.7 }, { "date": daysAgo(22), "score": null }, { "date": daysAgo(20), "score": -.5 }, { "date": daysAgo(10), "score": 1.2 }, { "date": daysAgo(5), "value": "2021-06-01T06:00:00.000Z", "score": 0.7 }] } }] }, { "name": "Bar", "summit": "I am at foo", "indicators": [{ "summary": "Another Location", "target": { "type": "LocationTarget", "dimension": "Another dimension", "good": 7, "ok": 21, "history": [{ "date": daysAgo(35), "score": 1.1 }, { "date": daysAgo(27), "score": .2 }, { "date": daysAgo(20), "score": .7 }, { "date": daysAgo(14), "score": 0.9 }, { "date": daysAgo(5), "score": -.2, "value": 18 }] } }] }]/*MODEL**/

        setInterval(() => location.reload(true), 5 * 60 * 1000)

        const $dashboard = $('#dashboard')
        const $_mountain = $('#mountain')
        const $_indicator = $('#indicator')

        $_mountain.remove()
        $_indicator.remove()

        const colorCode = ($element, score) => {
            if (score >= 1)
                $element.addClass('bg-success')
            else if (score <= 0)
                $element.addClass('bg-danger')
            else
                $element.addClass('bg-warning')
        }

        model.forEach(mountain => {
            $mountain = $_mountain.clone()
            $dashboard.append($mountain)
            $mountain.find('.about .name').html(mountain.name)
            $mountain.find('.about .summit').html(mountain.summit)

            let worst = 1
            mountain.indicators.forEach(indicator => {
                $indicator = $_indicator.clone()
                $mountain.append($indicator)

                $indicator.find('.summary').html(indicator.summary)
                $indicator.find('.description').html(indicator.description)

                const current = indicator.target.history[indicator.target.history.length - 1]
                worst = Math.min(worst, current.score)
                colorCode($indicator, current.score)

                const $graph = $indicator.find('.graph')

                if (indicator.type == 'CoordinateIndicator') {
                    $indicator.find('.icon').prop('src', 'assets/icons/coordinate.png')
                }

                $indicator.find('.dimension').prop('title', indicator.target.dimension.description)
                $indicator.find('.dimension').html(indicator.target.dimension.summary)

                if (indicator.target.type == 'ArrivalTarget') {
                    $indicator.find('.icon').prop('src', 'assets/icons/calendar.png')

                    const format = value => value ? value.substring(0, 10) : ''

                    $indicator.find('.dimension').html(indicator.target.value + ' ' + indicator.target.dimension.summary)
                    $indicator.find('.value').html(format(current.value))

                    indicator.target.history = indicator.target.history.map(h => h.score != null ? h : { ...h, score: -100 })

                    drawHistory(indicator.target, $graph, { format })
                } else {
                    const format = value => Math.round(value * 10) / 10

                    $indicator.find('.value').html(format(current.value))

                    drawHistory(indicator.target, $graph, { format })
                }
            })

            colorCode($mountain.find('.about'), worst)
        })

        function drawHistory(target, $graph, { format }) {

            const fontSize = 20
            const padding = fontSize
            const margin = 5
            const window = 8 * 7 * 24 * 3600 * 1000

            const now = new Date()
            const start = new Date(now.getTime() - window)
            const history = target.history

            const $canvas = $graph.find('canvas')
            const ctx = $canvas[0].getContext("2d");

            const width = $graph.width() - margin
            const height = $canvas.prop('height')
            $canvas.prop('width', width + margin)

            const filtered = target.history.filter(t => t.score > -5 && new Date(t.date) >= start)
            const max = filtered.reduce((acc, i) => Math.max(acc, i.score), 1)
            const min = filtered.reduce((acc, i) => Math.min(acc, i.score), 0)

            const dx = width / (now - start)
            const dy = (height - padding * 2) / (max - min)

            const x = date => (date - start) * dx
            const y = score => height - (score - min) * dy - padding

            ctx.lineWidth = 3;
            ctx.strokeStyle = "white";

            const stroke = (x1, y1, x2, y2) => {
                ctx.beginPath()
                ctx.moveTo(x(x1), y(y1))
                ctx.lineTo(x(x2), y(y2))
                ctx.stroke()
            }

            stroke(start, 1, now, 1)
            stroke(start, 0, now, 0)

            for (let w = start.getTime(); w <= now.getTime(); w += 7 * 24 * 3600 * 1000) {
                stroke(new Date(w), 5 / dy, new Date(w), -5 / dy)
            }

            ctx.lineWidth = 9;
            ctx.beginPath();
            let status = history[0]
            ctx.moveTo(x(new Date(status.date)), y(status.score));

            for (let i = 1; i < history.length; i++) {
                status = history[i]
                ctx.lineTo(x(new Date(status.date)), y(status.score));
            }
            ctx.stroke();

            const current = history[history.length - 1]

            const write = (value, x1, y1) => ctx.fillText(format(value), x(x1) - 2, y(y1) + fontSize)

            ctx.font = fontSize + "px Arial"
            ctx.fillStyle = "white"
            ctx.textAlign = "right"

            write(target.ok, now, 0)
            write(target.good, now, 1)
        }
    </script>

</body>

</html>